(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(c){var k={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function h(o,n){n.mode=e.newLayout;n.tableHeading=false;if(n.layoutType==="definitionList"&&n.spanningLayout&&o.match(f("definitionListEnd"),false)){n.spanningLayout=false}}function d(q,p,n){if(n==="_"){if(q.eat("_")){return j(q,p,"italic",/__/,2)}else{return j(q,p,"em",/_/,1)}}if(n==="*"){if(q.eat("*")){return j(q,p,"bold",/\*\*/,2)}return j(q,p,"strong",/\*/,1)}if(n==="["){if(q.match(/\d+\]/)){p.footCite=true}return l(p)}if(n==="("){var o=q.match(/^(r|tm|c)\)/);if(o){return m(p,k.specialChar)}}if(n==="<"&&q.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return m(p,k.html)}if(n==="?"&&q.eat("?")){return j(q,p,"cite",/\?\?/,2)}if(n==="="&&q.eat("=")){return j(q,p,"notextile",/==/,2)}if(n==="-"&&!q.eat("-")){return j(q,p,"deletion",/-/,1)}if(n==="+"){return j(q,p,"addition",/\+/,1)}if(n==="~"){return j(q,p,"sub",/~/,1)}if(n==="^"){return j(q,p,"sup",/\^/,1)}if(n==="%"){return j(q,p,"span",/%/,1)}if(n==="@"){return j(q,p,"code",/@/,1)}if(n==="!"){var r=j(q,p,"image",/(?:\([^\)]+\))?!/,1);q.match(/^:\S+/);return r}return l(p)}function j(t,s,r,p,q){var o=t.pos>q?t.string.charAt(t.pos-q-1):null;var n=t.peek();if(s[r]){if((!n||/\W/.test(n))&&o&&/\S/.test(o)){var u=l(s);s[r]=false;return u}}else{if((!o||/\W/.test(o))&&n&&/\S/.test(n)&&t.match(new RegExp("^.*\\S"+p.source+"(?:\\W|$)"),false)){s[r]=true;s.mode=e.attributes}}return l(s)}function l(o){var n=i(o);if(n){return n}var p=[];if(o.layoutType){p.push(k[o.layoutType])}p=p.concat(a(o,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading"));if(o.layoutType==="header"){p.push(k.header+"-"+o.header)}return p.length?p.join(" "):null}function i(n){var o=n.layoutType;switch(o){case"notextile":case"code":case"pre":return k[o];default:if(n.notextile){return k.notextile+(o?(" "+k[o]):"")}return null}}function m(p,o){var n=i(p);if(n){return n}var q=l(p);if(o){return q?(q+" "+o):o}else{return q}}function a(o){var p=[];for(var n=1;n<arguments.length;++n){if(o[arguments[n]]){p.push(k[arguments[n]])}}return p}function b(p){var o=p.spanningLayout,q=p.layoutType;for(var n in p){if(p.hasOwnProperty(n)){delete p[n]}}p.mode=e.newLayout;if(o){p.layoutType=q;p.spanningLayout=true}}var g={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(n){switch(n){case"drawTable":return g.makeRe("^",g.single.drawTable,"$");case"html":return g.makeRe("^",g.single.html,"(?:",g.single.html,")*","$");case"linkDefinition":return g.makeRe("^",g.single.linkDefinition,"$");case"listLayout":return g.makeRe("^",g.single.list,f("allAttributes"),"*\\s+");case"tableCellAttributes":return g.makeRe("^",g.choiceRe(g.single.tableCellAttributes,f("allAttributes")),"+\\.");case"type":return g.makeRe("^",f("allTypes"));case"typeLayout":return g.makeRe("^",f("allTypes"),f("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return g.makeRe("^",f("allAttributes"),"+");case"allTypes":return g.choiceRe(g.single.div,g.single.foot,g.single.header,g.single.bc,g.single.bq,g.single.notextile,g.single.pre,g.single.table,g.single.para);case"allAttributes":return g.choiceRe(g.attributes.selector,g.attributes.css,g.attributes.lang,g.attributes.align,g.attributes.pad);default:return g.makeRe("^",g.single[n])}},makeRe:function(){var p="";for(var o=0;o<arguments.length;++o){var n=arguments[o];p+=(typeof n==="string")?n:n.source}return new RegExp(p)},choiceRe:function(){var o=[arguments[0]];for(var n=1;n<arguments.length;++n){o[n*2-1]="|";o[n*2]=arguments[n]}o.unshift("(?:");o.push(")");return g.makeRe.apply(null,o)}};function f(n){return(g.cache[n]||(g.cache[n]=g.createRe(n)))}var e={newLayout:function(p,o){if(p.match(f("typeLayout"),false)){o.spanningLayout=false;return(o.mode=e.blockType)(p,o)}var n;if(!i(o)){if(p.match(f("listLayout"),false)){n=e.list}else{if(p.match(f("drawTable"),false)){n=e.table}else{if(p.match(f("linkDefinition"),false)){n=e.linkDefinition}else{if(p.match(f("definitionList"))){n=e.definitionList}else{if(p.match(f("html"),false)){n=e.html}}}}}}return(o.mode=(n||e.text))(p,o)},blockType:function(p,o){var n,q;o.layoutType=null;if(n=p.match(f("type"))){q=n[0]}else{return(o.mode=e.text)(p,o)}if(n=q.match(f("header"))){o.layoutType="header";o.header=parseInt(n[0][1])}else{if(q.match(f("bq"))){o.layoutType="quote"}else{if(q.match(f("bc"))){o.layoutType="code"}else{if(q.match(f("foot"))){o.layoutType="footnote"}else{if(q.match(f("notextile"))){o.layoutType="notextile"}else{if(q.match(f("pre"))){o.layoutType="pre"}else{if(q.match(f("div"))){o.layoutType="div"}else{if(q.match(f("table"))){o.layoutType="table"}}}}}}}}o.mode=e.attributes;return l(o)},text:function(p,o){if(p.match(f("text"))){return l(o)}var n=p.next();if(n==='"'){return(o.mode=e.link)(p,o)}return d(p,o,n)},attributes:function(o,n){n.mode=e.layoutLength;if(o.match(f("attributes"))){return m(n,k.attributes)}else{return l(n)}},layoutLength:function(o,n){if(o.eat(".")&&o.eat(".")){n.spanningLayout=true}n.mode=e.text;return l(n)},list:function(q,p){var o=q.match(f("list"));p.listDepth=o[0].length;var n=(p.listDepth-1)%3;if(!n){p.layoutType="list1"}else{if(n===1){p.layoutType="list2"}else{p.layoutType="list3"}}p.mode=e.attributes;return l(p)},link:function(o,n){n.mode=e.text;if(o.match(f("link"))){o.match(/\S+/);return m(n,k.link)}return l(n)},linkDefinition:function(o,n){o.skipToEnd();return m(n,k.linkDefinition)},definitionList:function(o,n){o.match(f("definitionList"));n.layoutType="definitionList";if(o.match(/\s*$/)){n.spanningLayout=true}else{n.mode=e.attributes}return l(n)},html:function(o,n){o.skipToEnd();return m(n,k.html)},table:function(o,n){n.layoutType="table";return(n.mode=e.tableCell)(o,n)},tableCell:function(o,n){if(o.match(f("tableHeading"))){n.tableHeading=true}else{o.eat("|")}n.mode=e.tableCellAttributes;return l(n)},tableCellAttributes:function(o,n){n.mode=e.tableText;if(o.match(f("tableCellAttributes"))){return m(n,k.attributes)}else{return l(n)}},tableText:function(o,n){if(o.match(f("tableText"))){return l(n)}if(o.peek()==="|"){n.mode=e.tableCell;return l(n)}return d(o,n,o.next())}};c.defineMode("textile",function(){return{startState:function(){return{mode:e.newLayout}},token:function(o,n){if(o.sol()){h(o,n)}return n.mode(o,n)},blankLine:b}});c.defineMIME("text/x-textile","textile")});