(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets"))}else{if(typeof define=="function"&&define.amd){define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],a)}else{a(CodeMirror)}}})(function(c){var k=c.keyMap.sublime={fallthrough:"default"};var b=c.commands;var o=c.Pos;var j=c.keyMap["default"]==c.keyMap.macDefault;var d=j?"Cmd-":"Ctrl-";function f(x,D,w){if(w<0&&D.ch==0){return x.clipPos(o(D.line-1))}var A=x.getLine(D.line);if(w>0&&D.ch>=A.length){return x.clipPos(o(D.line+1,0))}var E="start",F;for(var C=D.ch,y=w<0?0:A.length,z=0;C!=y;C+=w,z++){var B=A.charAt(w<0?C-1:C);var v=B!="_"&&c.isWordChar(B)?"w":"o";if(v=="w"&&B.toUpperCase()==B){v="W"}if(E=="start"){if(v!="o"){E="in";F=v}}else{if(E=="in"){if(F!=v){if(F=="w"&&v=="W"&&w<0){C--}if(F=="W"&&v=="w"&&w>0){F="w";continue}break}}}}return o(D.line,C)}function n(v,w){v.extendSelectionsBy(function(x){if(v.display.shift||v.doc.extend||x.empty()){return f(v.doc,x.head,w)}else{return w<0?x.from():x.to()}})}var h=j?"Ctrl-":"Alt-";b[k[h+"Left"]="goSubwordLeft"]=function(v){n(v,-1)};b[k[h+"Right"]="goSubwordRight"]=function(v){n(v,1)};if(j){k["Cmd-Left"]="goLineStartSmart"}var p=j?"Ctrl-Alt-":"Ctrl-";b[k[p+"Up"]="scrollLineUp"]=function(v){var w=v.getScrollInfo();if(!v.somethingSelected()){var x=v.lineAtHeight(w.top+w.clientHeight,"local");if(v.getCursor().line>=x){v.execCommand("goLineUp")}}v.scrollTo(null,w.top-v.defaultTextHeight())};b[k[p+"Down"]="scrollLineDown"]=function(v){var w=v.getScrollInfo();if(!v.somethingSelected()){var x=v.lineAtHeight(w.top,"local")+1;if(v.getCursor().line<=x){v.execCommand("goLineDown")}}v.scrollTo(null,w.top+v.defaultTextHeight())};b[k["Shift-"+d+"L"]="splitSelectionByLine"]=function(v){var A=v.listSelections(),z=[];for(var x=0;x<A.length;x++){var w=A[x].from(),B=A[x].to();for(var y=w.line;y<=B.line;++y){if(!(B.line>w.line&&y==B.line&&B.ch==0)){z.push({anchor:y==w.line?w:o(y,0),head:y==B.line?B:o(y)})}}}v.setSelections(z,0)};k["Shift-Tab"]="indentLess";b[k.Esc="singleSelectionTop"]=function(v){var w=v.listSelections()[0];v.setSelection(w.anchor,w.head,{scroll:false})};b[k[d+"L"]="selectLine"]=function(v){var z=v.listSelections(),w=[];for(var x=0;x<z.length;x++){var y=z[x];w.push({anchor:o(y.from().line,0),head:o(y.to().line+1,0)})}v.setSelections(w)};k["Shift-Ctrl-K"]="deleteLine";function i(w,v){if(w.isReadOnly()){return c.Pass}w.operation(function(){var B=w.listSelections().length,C=[],A=-1;for(var z=0;z<B;z++){var y=w.listSelections()[z].head;if(y.line<=A){continue}var x=o(y.line+(v?0:1),0);w.replaceRange("\n",x,null,"+insertLine");w.indentLine(x.line,null,true);C.push({head:x,anchor:x});A=y.line+1}w.setSelections(C)});w.execCommand("indentAuto")}b[k[d+"Enter"]="insertLineAfter"]=function(v){return i(v,false)};b[k["Shift-"+d+"Enter"]="insertLineBefore"]=function(v){return i(v,true)};function u(v,y){var z=y.ch,w=z,x=v.getLine(y.line);while(z&&c.isWordChar(x.charAt(z-1))){--z}while(w<x.length&&c.isWordChar(x.charAt(w))){++w}return{from:o(y.line,z),to:o(y.line,w),word:x.slice(z,w)}}b[k[d+"D"]="selectNextOccurrence"]=function(v){var x=v.getCursor("from"),B=v.getCursor("to");var y=v.state.sublimeFindFullWord==v.doc.sel;if(c.cmpPos(x,B)==0){var C=u(v,x);if(!C.word){return}v.setSelection(C.from,C.to);y=true}else{var A=v.getRange(x,B);var z=y?new RegExp("\\b"+A+"\\b"):A;var w=v.getSearchCursor(z,B);if(w.findNext()){v.addSelection(w.from(),w.to())}else{w=v.getSearchCursor(z,o(v.firstLine(),0));if(w.findNext()){v.addSelection(w.from(),w.to())}}}if(y){v.state.sublimeFindFullWord=v.doc.sel}};var l="(){}[]";function q(w){var y=w.getCursor(),x=w.scanForBracket(y,-1);if(!x){return}for(;;){var v=w.scanForBracket(y,1);if(!v){return}if(v.ch==l.charAt(l.indexOf(x.ch)+1)){w.setSelection(o(x.pos.line,x.pos.ch+1),v.pos,false);return true}y=o(v.pos.line,v.pos.ch+1)}}b[k["Shift-"+d+"Space"]="selectScope"]=function(v){q(v)||v.execCommand("selectAll")};b[k["Shift-"+d+"M"]="selectBetweenBrackets"]=function(v){if(!q(v)){return c.Pass}};b[k[d+"M"]="goToBracket"]=function(v){v.extendSelectionsBy(function(y){var w=v.scanForBracket(y.head,1);if(w&&c.cmpPos(w.pos,y.head)!=0){return w.pos}var x=v.scanForBracket(y.head,-1);return x&&o(x.pos.line,x.pos.ch+1)||y.head})};var t=j?"Cmd-Ctrl-":"Shift-Ctrl-";b[k[t+"Up"]="swapLineUp"]=function(w){if(w.isReadOnly()){return c.Pass}var C=w.listSelections(),z=[],v=w.firstLine()-1,A=[];for(var y=0;y<C.length;y++){var B=C[y],x=B.from().line-1,D=B.to().line;A.push({anchor:o(B.anchor.line-1,B.anchor.ch),head:o(B.head.line-1,B.head.ch)});if(B.to().ch==0&&!B.empty()){--D}if(x>v){z.push(x,D)}else{if(z.length){z[z.length-1]=D}}v=D}w.operation(function(){for(var F=0;F<z.length;F+=2){var E=z[F],H=z[F+1];var G=w.getLine(E);w.replaceRange("",o(E,0),o(E+1,0),"+swapLine");if(H>w.lastLine()){w.replaceRange("\n"+G,o(w.lastLine()),null,"+swapLine")}else{w.replaceRange(G+"\n",o(H,0),null,"+swapLine")}}w.setSelections(A);w.scrollIntoView()})};b[k[t+"Down"]="swapLineDown"]=function(w){if(w.isReadOnly()){return c.Pass}var B=w.listSelections(),z=[],v=w.lastLine()+1;for(var y=B.length-1;y>=0;y--){var A=B[y],x=A.to().line+1,C=A.from().line;if(A.to().ch==0&&!A.empty()){x--}if(x<v){z.push(x,C)}else{if(z.length){z[z.length-1]=C}}v=C}w.operation(function(){for(var E=z.length-2;E>=0;E-=2){var D=z[E],G=z[E+1];var F=w.getLine(D);if(D==w.lastLine()){w.replaceRange("",o(D-1),o(D),"+swapLine")}else{w.replaceRange("",o(D,0),o(D+1,0),"+swapLine")}w.replaceRange(F+"\n",o(G,0),null,"+swapLine")}w.scrollIntoView()})};b[k[d+"/"]="toggleCommentIndented"]=function(v){v.toggleComment({indent:true})};b[k[d+"J"]="joinLines"]=function(v){var B=v.listSelections(),z=[];for(var y=0;y<B.length;y++){var A=B[y],x=A.from();var C=x.line,w=A.to().line;while(y<B.length-1&&B[y+1].from().line==w){w=B[++y].to().line}z.push({start:C,end:w,anchor:!A.empty()&&x})}v.operation(function(){var J=0,K=[];for(var G=0;G<z.length;G++){var I=z[G];var E=I.anchor&&o(I.anchor.line-J,I.anchor.ch),F;for(var H=I.start;H<=I.end;H++){var D=H-J;if(H==I.end){F=o(D,v.getLine(D).length+1)}if(D<v.lastLine()){v.replaceRange(" ",o(D),o(D+1,/^\s*/.exec(v.getLine(D+1))[0].length));++J}}K.push({anchor:E||F,head:F})}v.setSelections(K,0)})};b[k["Shift-"+d+"D"]="duplicateLine"]=function(v){v.operation(function(){var y=v.listSelections().length;for(var w=0;w<y;w++){var x=v.listSelections()[w];if(x.empty()){v.replaceRange(v.getLine(x.head.line)+"\n",o(x.head.line,0))}else{v.replaceRange(v.getRange(x.from(),x.to()),x.from())}}v.scrollIntoView()})};k[d+"T"]="transposeChars";function s(w,v){if(w.isReadOnly()){return c.Pass}var A=w.listSelections(),D=[],B;for(var y=0;y<A.length;y++){var z=A[y];if(z.empty()){continue}var x=z.from().line,C=z.to().line;while(y<A.length-1&&A[y+1].from().line==C){C=z[++y].to().line}D.push(x,C)}if(D.length){B=true}else{D.push(w.firstLine(),w.lastLine())}w.operation(function(){var I=[];for(var G=0;G<D.length;G+=2){var F=D[G],K=D[G+1];var J=o(F,0),E=o(K);var H=w.getRange(J,E,false);if(v){H.sort()}else{H.sort(function(L,N){var M=L.toUpperCase(),O=N.toUpperCase();if(M!=O){L=M;N=O}return L<N?-1:L==N?0:1})}w.replaceRange(H,J,E);if(B){I.push({anchor:J,head:E})}}if(B){w.setSelections(I,0)}})}b[k.F9="sortLines"]=function(v){s(v,true)};b[k[d+"F9"]="sortLinesInsensitive"]=function(v){s(v,false)};b[k.F2="nextBookmark"]=function(v){var y=v.state.sublimeBookmarks;if(y){while(y.length){var w=y.shift();var x=w.find();if(x){y.push(w);return v.setSelection(x.from,x.to)}}}};b[k["Shift-F2"]="prevBookmark"]=function(v){var x=v.state.sublimeBookmarks;if(x){while(x.length){x.unshift(x.pop());var w=x[x.length-1].find();if(!w){x.pop()}else{return v.setSelection(w.from,w.to)}}}};b[k[d+"F2"]="toggleBookmark"]=function(v){var C=v.listSelections();var B=v.state.sublimeBookmarks||(v.state.sublimeBookmarks=[]);for(var y=0;y<C.length;y++){var x=C[y].from(),D=C[y].to();var w=v.findMarks(x,D);for(var z=0;z<w.length;z++){if(w[z].sublimeBookmark){w[z].clear();for(var A=0;A<B.length;A++){if(B[A]==w[z]){B.splice(A--,1)}}break}}if(z==w.length){B.push(v.markText(x,D,{sublimeBookmark:true,clearWhenEmpty:false}))}}};b[k["Shift-"+d+"F2"]="clearBookmarks"]=function(v){var x=v.state.sublimeBookmarks;if(x){for(var w=0;w<x.length;w++){x[w].clear()}}x.length=0};b[k["Alt-F2"]="selectBookmarks"]=function(v){var y=v.state.sublimeBookmarks,z=[];if(y){for(var x=0;x<y.length;x++){var w=y[x].find();if(!w){y.splice(x--,0)}else{z.push({anchor:w.from,head:w.to})}}}if(z.length){v.setSelections(z,0)}};k["Alt-Q"]="wrapLines";var a=d+"K ";function m(v,w){v.operation(function(){var B=v.listSelections(),z=[],C=[];for(var y=0;y<B.length;y++){var A=B[y];if(A.empty()){z.push(y);C.push("")}else{C.push(w(v.getRange(A.from(),A.to())))}}v.replaceSelections(C,"around","case");for(var y=z.length-1,x;y>=0;y--){var A=B[z[y]];if(x&&c.cmpPos(A.head,x)>0){continue}var D=u(v,A.head);x=D.from;v.replaceRange(w(D.word),D.from,D.to)}})}k[a+d+"Backspace"]="delLineLeft";b[k.Backspace="smartBackspace"]=function(v){if(v.somethingSelected()){return c.Pass}v.operation(function(){var y=v.listSelections();var B=v.getOption("indentUnit");for(var A=y.length-1;A>=0;A--){var x=y[A].head;var D=v.getRange({line:x.line,ch:0},x);var w=c.countColumn(D,null,v.getOption("tabSize"));var z=v.findPosH(x,-1,"char",false);if(D&&!/\S/.test(D)&&w%B==0){var C=new o(x.line,c.findColumn(D,w-B,B));if(C.ch!=x.ch){z=C}}v.replaceRange("",z,x,"+delete")}})};b[k[a+d+"K"]="delLineRight"]=function(v){v.operation(function(){var x=v.listSelections();for(var w=x.length-1;w>=0;w--){v.replaceRange("",x[w].anchor,o(x[w].to().line),"+delete")}v.scrollIntoView()})};b[k[a+d+"U"]="upcaseAtCursor"]=function(v){m(v,function(w){return w.toUpperCase()})};b[k[a+d+"L"]="downcaseAtCursor"]=function(v){m(v,function(w){return w.toLowerCase()})};b[k[a+d+"Space"]="setSublimeMark"]=function(v){if(v.state.sublimeMark){v.state.sublimeMark.clear()}v.state.sublimeMark=v.setBookmark(v.getCursor())};b[k[a+d+"A"]="selectToSublimeMark"]=function(v){var w=v.state.sublimeMark&&v.state.sublimeMark.find();if(w){v.setSelection(v.getCursor(),w)}};b[k[a+d+"W"]="deleteToSublimeMark"]=function(v){var w=v.state.sublimeMark&&v.state.sublimeMark.find();if(w){var x=v.getCursor(),z=w;if(c.cmpPos(x,z)>0){var y=z;z=x;x=y}v.state.sublimeKilled=v.getRange(x,z);v.replaceRange("",x,z)}};b[k[a+d+"X"]="swapWithSublimeMark"]=function(v){var w=v.state.sublimeMark&&v.state.sublimeMark.find();if(w){v.state.sublimeMark.clear();v.state.sublimeMark=v.setBookmark(v.getCursor());v.setCursor(w)}};b[k[a+d+"Y"]="sublimeYank"]=function(v){if(v.state.sublimeKilled!=null){v.replaceSelection(v.state.sublimeKilled,null,"paste")}};k[a+d+"G"]="clearBookmarks";b[k[a+d+"C"]="showInCenter"]=function(v){var w=v.cursorCoords(null,"local");v.scrollTo(null,(w.top+w.bottom)/2-v.getScrollInfo().clientHeight/2)};var r=j?"Ctrl-Shift-":"Ctrl-Alt-";b[k[r+"Up"]="selectLinesUpward"]=function(v){v.operation(function(){var y=v.listSelections();for(var w=0;w<y.length;w++){var x=y[w];if(x.head.line>v.firstLine()){v.addSelection(o(x.head.line-1,x.head.ch))}}})};b[k[r+"Down"]="selectLinesDownward"]=function(v){v.operation(function(){var y=v.listSelections();for(var w=0;w<y.length;w++){var x=y[w];if(x.head.line<v.lastLine()){v.addSelection(o(x.head.line+1,x.head.ch))}}})};function g(v){var w=v.getCursor("from"),x=v.getCursor("to");if(c.cmpPos(w,x)==0){var y=u(v,w);if(!y.word){return}w=y.from;x=y.to}return{from:w,to:x,query:v.getRange(w,x),word:y}}function e(v,x){var z=g(v);if(!z){return}var y=z.query;var w=v.getSearchCursor(y,x?z.to:z.from);if(x?w.findNext():w.findPrevious()){v.setSelection(w.from(),w.to())}else{w=v.getSearchCursor(y,x?o(v.firstLine(),0):v.clipPos(o(v.lastLine())));if(x?w.findNext():w.findPrevious()){v.setSelection(w.from(),w.to())}else{if(z.word){v.setSelection(z.from,z.to)}}}}b[k[d+"F3"]="findUnder"]=function(v){e(v,true)};b[k["Shift-"+d+"F3"]="findUnderPrevious"]=function(v){e(v,false)};b[k["Alt-F3"]="findAllUnder"]=function(v){var z=g(v);if(!z){return}var w=v.getSearchCursor(z.query);var x=[];var y=-1;while(w.findNext()){x.push({anchor:w.from(),head:w.to()});if(w.from().line<=z.from.line&&w.from().ch<=z.from.ch){y++}}v.setSelections(x,y)};k["Shift-"+d+"["]="fold";k["Shift-"+d+"]"]="unfold";k[a+d+"0"]=k[a+d+"j"]="unfoldAll";k[d+"I"]="findIncremental";k["Shift-"+d+"I"]="findIncrementalReverse";k[d+"H"]="replace";k.F3="findNext";k["Shift-F3"]="findPrev";c.normalizeKeyMap(k)});