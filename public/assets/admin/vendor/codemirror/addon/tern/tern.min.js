(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(h){h.TernServer=function(L){var N=this;this.options=L||{};var M=this.options.plugins||(this.options.plugins={});if(!M.doc_comment){M.doc_comment=true}this.docs=Object.create(null);if(this.options.useWorker){this.server=new K(this)}else{this.server=new tern.Server({getFile:function(P,O){return o(N,P,O)},async:true,defs:this.options.defs||[],plugins:M})}this.trackChange=function(P,O){H(N,P,O)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[];this.getHint=function(P,O){return q(N,P,O)};this.getHint.async=true};h.TernServer.prototype={addDoc:function(N,M){var L={doc:M,name:N,changed:null};this.server.addFile(N,j(this,L));h.on(M,"change",this.trackChange);return this.docs[N]=L},delDoc:function(M){var L=A(this,M);if(!L){return}h.off(L.doc,"change",this.trackChange);delete this.docs[L.name];this.server.delFile(L.name)},hideDoc:function(M){e(this);var L=A(this,M);if(L&&L.changed){C(this,L)}},complete:function(L){L.showHint({hint:this.getHint})},showType:function(M,N,L){E(this,M,N,"type",L)},showDocs:function(M,N,L){E(this,M,N,"documentation",L)},updateArgHints:function(L){J(this,L)},jumpToDef:function(L){s(this,L)},jumpBack:function(L){r(this,L)},rename:function(L){z(this,L)},selectName:function(L){B(this,L)},request:function(M,R,L,P){var T=this;var N=n(this,M.getDoc());var S=d(this,N,R,P);var O=S.query&&this.options.queryOptions&&this.options.queryOptions[S.query.type];if(O){for(var Q in O){S.query[Q]=O[Q]}}this.server.request(S,function(V,U){if(!V&&T.options.responseFilter){U=T.options.responseFilter(N,R,S,V,U)}L(V,U)})},destroy:function(){e(this);if(this.worker){this.worker.terminate();this.worker=null}}};var x=h.Pos;var f="CodeMirror-Tern-";var c=250;function o(O,N,M){var L=O.docs[N];if(L){M(j(O,L))}else{if(O.options.getFile){O.options.getFile(N,M)}else{M(null)}}}function n(Q,M,P){for(var O in Q.docs){var L=Q.docs[O];if(L.doc==M){return L}}if(!P){for(var N=0;;++N){O="[doc"+(N||"")+"]";if(!Q.docs[O]){P=O;break}}}return Q.addDoc(P,M)}function A(M,L){if(typeof L=="string"){return M.docs[L]}if(L instanceof h){L=L.getDoc()}if(L instanceof h.Doc){return n(M,L)}}function H(R,P,M){var O=n(R,P);var L=R.cachedArgHints;if(L&&L.doc==P&&g(L.start,M.to)>=0){R.cachedArgHints=null}var N=O.changed;if(N==null){O.changed=N={from:M.from.line,to:M.from.line}}var Q=M.from.line+(M.text.length-1);if(M.from.line<N.to){N.to=N.to-(M.to.line-Q)}if(Q>=N.to){N.to=Q+1}if(N.from>M.from.line){N.from=M.from.line}if(P.lineCount()>c&&M.to-N.from>100){setTimeout(function(){if(O.changed&&O.changed.to-O.changed.from>100){C(R,O)}},200)}}function C(M,L){M.server.request({files:[{type:"full",name:L.name,text:j(M,L)}]},function(N){if(N){window.console.error(N)}else{L.changed=null}})}function q(N,M,L){N.request(M,{type:"completions",types:true,docs:true,urls:true},function(T,S){if(T){return F(N,M,T)}var R=[],O="";var U=S.start,X=S.end;if(M.getRange(x(U.line,U.ch-2),U)=='["'&&M.getRange(X,x(X.line,X.ch+2))!='"]'){O='"]'}for(var V=0;V<S.completions.length;++V){var Q=S.completions[V],P=I(Q.type);if(S.guess){P+=" "+f+"guess"}R.push({text:Q.name+O,displayText:Q.displayName||Q.name,className:P,data:Q})}var W={from:U,to:X,list:R};var Y=null;h.on(W,"close",function(){y(Y)});h.on(W,"update",function(){y(Y)});h.on(W,"select",function(aa,ab){y(Y);var Z=N.options.completionTip?N.options.completionTip(aa.data):aa.data.doc;if(Z){Y=t(ab.parentNode.getBoundingClientRect().right+window.pageXOffset,ab.getBoundingClientRect().top+window.pageYOffset,Z);Y.className+=" "+f+"hint-doc"}});L(W)})}function I(M){var L;if(M=="?"){L="unknown"}else{if(M=="number"||M=="string"||M=="bool"){L=M}else{if(/^fn\(/.test(M)){L="fn"}else{if(/^\[/.test(M)){L="array"}else{L="object"}}}}return f+"completion "+f+"completion-"+L}function E(P,M,N,O,L){P.request(M,O,function(S,R){if(S){return F(P,M,S)}if(P.options.typeTip){var T=P.options.typeTip(R)}else{var T=k("span",null,k("strong",null,R.type||"not found"));if(R.doc){T.appendChild(document.createTextNode(" — "+R.doc))}if(R.url){T.appendChild(document.createTextNode(" "));var Q=T.appendChild(k("a",null,"[docs]"));Q.href=R.url;Q.target="_blank"}}G(M,T,P);if(L){L()}},N)}function J(ab,O){e(ab);if(O.somethingSelected()){return}var X=O.getTokenAt(O.getCursor()).state;var S=h.innerMode(O.getMode(),X);if(S.mode.name!="javascript"){return}var T=S.state.lexical;if(T.info!="call"){return}var N,L=T.pos||0,aa=O.getOption("tabSize");for(var U=O.getCursor().line,P=Math.max(0,U-9),R=false;U>=P;--U){var Y=O.getLine(U),Q=0;for(var V=0;;){var Z=Y.indexOf("\t",V);if(Z==-1){break}Q+=aa-(Z+Q)%aa-1;V=Z+1}N=T.column-Q;if(Y.charAt(N)=="("){R=true;break}}if(!R){return}var W=x(U,N);var M=ab.cachedArgHints;if(M&&M.doc==O.getDoc()&&g(W,M.start)==0){return D(ab,O,L)}ab.request(O,{type:"type",preferFunction:true,end:W},function(ad,ac){if(ad||!ac.type||!(/^fn\(/).test(ac.type)){return}ab.cachedArgHints={start:W,type:w(ac.type),name:ac.exprName||ac.name||"fn",guess:ac.guess,doc:O.getDoc()};D(ab,O,L)})}function D(T,N,Q){e(T);var M=T.cachedArgHints,S=M.type;var R=k("span",M.guess?f+"fhint-guess":null,k("span",f+"fname",M.name),"(");for(var O=0;O<S.args.length;++O){if(O){R.appendChild(document.createTextNode(", "))}var L=S.args[O];R.appendChild(k("span",f+"farg"+(O==Q?" "+f+"farg-current":""),L.name||"?"));if(L.type!="?"){R.appendChild(document.createTextNode(":\u00a0"));R.appendChild(k("span",f+"type",L.type))}}R.appendChild(document.createTextNode(S.rettype?") ->\u00a0":")"));if(S.rettype){R.appendChild(k("span",f+"type",S.rettype))}var P=N.cursorCoords(null,"page");T.activeArgHints=t(P.right+1,P.bottom,R)}function w(Q){var L=[],N=3;function P(U){var R=0,T=N;for(;;){var S=Q.charAt(N);if(U.test(S)&&!R){return Q.slice(T,N)}if(/[{\[\(]/.test(S)){++R}else{if(/[}\]\)]/.test(S)){--R}}++N}}if(Q.charAt(N)!=")"){for(;;){var M=Q.slice(N).match(/^([^, \(\[\{]+): /);if(M){N+=M[0].length;M=M[1]}L.push({name:M,type:P(/[\),]/)});if(Q.charAt(N)==")"){break}N+=2}}var O=Q.slice(N).match(/^\) -> (.*)$/);return{args:L,rettype:O&&O[1]}}function s(N,L){function M(Q){var P={type:"definition",variable:Q||null};var O=n(N,L.getDoc());N.server.request(d(N,O,P),function(S,R){if(S){return F(N,L,S)}if(!R.file&&R.url){window.open(R.url);return}if(R.file){var U=N.docs[R.file],T;if(U&&(T=m(U.doc,R))){N.jumpStack.push({file:O.name,start:L.getCursor("from"),end:L.getCursor("to")});u(N,O,U,T.start,T.end);return}}F(N,L,"Could not find a definition.")})}if(!b(L)){i(L,"Jump to variable",function(O){if(O){M(O)}})}else{M()}}function r(O,L){var N=O.jumpStack.pop(),M=N&&O.docs[N.file];if(!M){return}u(O,n(O,L.getDoc()),M,N.start,N.end)}function u(P,L,M,O,N){M.doc.setSelection(O,N);if(L!=M&&P.options.switchToDoc){e(P);P.options.switchToDoc(M.name,M.doc)}}function m(Q,O){var L=O.context.slice(0,O.contextOffset).split("\n");var W=O.start.line-(L.length-1);var V=x(W,(L.length==1?O.start.ch:Q.getLine(W).length)-L[0].length);var X=Q.getLine(W).slice(V.ch);for(var M=W+1;M<Q.lineCount()&&X.length<O.context.length;++M){X+="\n"+Q.getLine(M)}if(X.slice(0,O.context.length)==O.context){return O}var N=Q.getSearchCursor(O.context,0,false);var T,U=Infinity;while(N.findNext()){var S=N.from(),P=Math.abs(S.line-V.line)*10000;if(!P){P=Math.abs(S.ch-V.ch)}if(P<U){T=S;U=P}}if(!T){return null}if(L.length==1){T.ch+=L[0].length}else{T=x(T.line+(L.length-1),L[L.length-1].length)}if(O.start.line==O.end.line){var R=x(T.line,T.ch+(O.end.ch-O.start.ch))}else{var R=x(T.line+(O.end.line-O.start.line),O.end.ch)}return{start:T,end:R}}function b(L){var M=L.getCursor("end"),N=L.getTokenAt(M);if(N.start<M.ch&&N.type=="comment"){return false}return/[\w)\]]/.test(L.getLine(M.line).slice(Math.max(M.ch-1,0),M.ch+1))}function z(N,L){var M=L.getTokenAt(L.getCursor());if(!/\w/.test(M.string)){return F(N,L,"Not at a variable")}i(L,"New name for "+M.string,function(O){N.request(L,{type:"rename",newName:O,fullDocs:true},function(Q,P){if(Q){return F(N,L,Q)}a(N,P.changes)})})}function B(N,L){var M=n(N,L.doc).name;N.request(L,{type:"refs"},function(R,Q){if(R){return F(N,L,R)}var T=[],O=0;var P=L.getCursor();for(var S=0;S<Q.refs.length;S++){var U=Q.refs[S];if(U.file==M){T.push({anchor:U.start,head:U.end});if(g(P,U.start)>=0&&g(P,U.end)<=0){O=T.length-1}}}L.setSelections(T,O)})}var v=0;function a(T,M){var S=Object.create(null);for(var P=0;P<M.length;++P){var L=M[P];(S[L.file]||(S[L.file]=[])).push(L)}for(var O in S){var Q=T.docs[O],N=S[O];if(!Q){continue}N.sort(function(U,V){return g(V.start,U.start)});var R="*rename"+(++v);for(var P=0;P<N.length;++P){var L=N[P];Q.doc.replaceRange(L.text,L.start,L.end,R)}}}function d(U,N,S,R){var O=[],Q=0,L=!S.fullDocs;if(!L){delete S.fullDocs}if(typeof S=="string"){S={type:S}}S.lineCharPositions=true;if(S.end==null){S.end=R||N.doc.getCursor("end");if(N.doc.somethingSelected()){S.start=N.doc.getCursor("start")}}var T=S.start||S.end;if(N.changed){if(N.doc.lineCount()>c&&L!==false&&N.changed.to-N.changed.from<100&&N.changed.from<=T.line&&N.changed.to>S.end.line){O.push(p(N,T,S.end));S.file="#0";var Q=O[0].offsetLines;if(S.start!=null){S.start=x(S.start.line- -Q,S.start.ch)}S.end=x(S.end.line-Q,S.end.ch)}else{O.push({type:"full",name:N.name,text:j(U,N)});S.file=N.name;N.changed=null}}else{S.file=N.name}for(var P in U.docs){var M=U.docs[P];if(M.changed&&M!=N){O.push({type:"full",name:M.name,text:j(U,M)});M.changed=null}}return{query:S,files:O}}function p(L,Y,N){var M=L.doc;var V=null,W=null,O,Z=4;for(var X=Y.line-1,U=Math.max(0,X-50);X>=U;--X){var S=M.getLine(X),P=S.search(/\bfunction\b/);if(P<0){continue}var R=h.countColumn(S,null,Z);if(V!=null&&V<=R){continue}V=R;W=X}if(W==null){W=U}var T=Math.min(M.lastLine(),N.line+20);if(V==null||V==h.countColumn(M.getLine(Y.line),null,Z)){O=T}else{for(O=N.line+1;O<T;++O){var R=h.countColumn(M.getLine(O),null,Z);if(R<=V){break}}}var Q=x(W,0);return{type:"part",name:L.name,offsetLines:Q.line,text:M.getRange(Q,x(O,0))}}var g=h.cmpPos;function k(P,L){var M=document.createElement(P);if(L){M.className=L}for(var O=2;O<arguments.length;++O){var N=arguments[O];if(typeof N=="string"){N=document.createTextNode(N)}M.appendChild(N)}return M}function i(L,N,M){if(L.openDialog){L.openDialog(N+": <input type=text>",M)}else{M(prompt(N,""))}}function G(M,N,S){if(M.state.ternTooltip){y(M.state.ternTooltip)}var T=M.cursorCoords();var R=M.state.ternTooltip=t(T.right+1,T.bottom,N);function O(){Q=true;if(!P){L()}}function L(){M.state.ternTooltip=null;if(!R.parentNode){return}M.off("cursorActivity",L);M.off("blur",L);M.off("scroll",L);l(R)}var P=false,Q=false;h.on(R,"mousemove",function(){P=true});h.on(R,"mouseout",function(U){if(!h.contains(R,U.relatedTarget||U.toElement)){if(Q){L()}else{P=false}}});setTimeout(O,S.options.hintDelay?S.options.hintDelay:1700);M.on("cursorActivity",L);M.on("blur",L);M.on("scroll",L)}function t(N,O,L){var M=k("div",f+"tooltip",L);M.style.left=N+"px";M.style.top=O+"px";document.body.appendChild(M);return M}function y(L){var M=L&&L.parentNode;if(M){M.removeChild(L)}}function l(L){L.style.opacity="0";setTimeout(function(){y(L)},1100)}function F(N,L,M){if(N.options.showError){N.options.showError(L,M)}else{G(L,String(M),N)}}function e(L){if(L.activeArgHints){y(L.activeArgHints);L.activeArgHints=null}}function j(M,L){var N=L.doc.getValue();if(M.options.fileFilter){N=M.options.fileFilter(N,L.name,L.doc)}return N}function K(O){var P=O.worker=new Worker(O.options.workerScript);P.postMessage({type:"init",defs:O.options.defs,plugins:O.options.plugins,scripts:O.options.workerDeps});var L=0,M={};function N(R,Q){if(Q){R.id=++L;M[L]=Q}P.postMessage(R)}P.onmessage=function(R){var Q=R.data;if(Q.type=="getFile"){o(O,Q.name,function(S,T){N({type:"getFile",err:String(S),text:T,id:Q.id})})}else{if(Q.type=="debug"){window.console.log(Q.message)}else{if(Q.id&&M[Q.id]){M[Q.id](Q.err,Q.body);delete M[Q.id]}}}};P.onerror=function(Q){for(var R in M){M[R](Q)}M={}};this.addFile=function(Q,R){N({type:"add",name:Q,text:R})};this.delFile=function(Q){N({type:"del",name:Q})};this.request=function(Q,R){N({type:"req",body:Q},R)}}});