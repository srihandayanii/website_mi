(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./foldcode"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./foldcode"],a)}else{a(CodeMirror)}}})(function(a){a.defineOption("foldGutter",false,function(m,o,n){if(n&&n!=a.Init){m.clearGutter(m.state.foldGutter.options.gutter);m.state.foldGutter=null;m.off("gutterClick",f);m.off("change",d);m.off("viewportChange",g);m.off("fold",e);m.off("unfold",e);m.off("swapDoc",d)}if(o){m.state.foldGutter=new j(h(o));l(m);m.on("gutterClick",f);m.on("change",d);m.on("viewportChange",g);m.on("fold",e);m.on("unfold",e);m.on("swapDoc",d)}});var i=a.Pos;function j(m){this.options=m;this.from=this.to=0}function h(m){if(m===true){m={}}if(m.gutter==null){m.gutter="CodeMirror-foldgutter"}if(m.indicatorOpen==null){m.indicatorOpen="CodeMirror-foldgutter-open"}if(m.indicatorFolded==null){m.indicatorFolded="CodeMirror-foldgutter-folded"}return m}function b(m,o){var p=m.findMarks(i(o,0),i(o+1,0));for(var n=0;n<p.length;++n){if(p[n].__isFold&&p[n].find().from.line==o){return p[n]}}}function c(n){if(typeof n=="string"){var m=document.createElement("div");m.className=n+" CodeMirror-guttermarker-subtle";return m}else{return n.cloneNode(true)}}function k(m,o,s){var r=m.state.foldGutter.options,n=o;var q=m.foldOption(r,"minFoldSize");var p=m.foldOption(r,"rangeFinder");m.eachLine(o,s,function(t){var u=null;if(b(m,n)){u=c(r.indicatorFolded)}else{var v=i(n,0);var w=p&&p(m,v);if(w&&w.to.line-w.from.line>=q){u=c(r.indicatorOpen)}}m.setGutterMarker(t,r.gutter,u);++n})}function l(m){var o=m.getViewport(),n=m.state.foldGutter;if(!n){return}m.operation(function(){k(m,o.from,o.to)});n.from=o.from;n.to=o.to}function f(m,p,o){var r=m.state.foldGutter;if(!r){return}var q=r.options;if(o!=q.gutter){return}var n=b(m,p);if(n){n.clear()}else{m.foldCode(i(p,0),q.rangeFinder)}}function d(m){var o=m.state.foldGutter;if(!o){return}var n=o.options;o.from=o.to=0;clearTimeout(o.changeUpdate);o.changeUpdate=setTimeout(function(){l(m)},n.foldOnChangeTimeSpan||600)}function g(m){var o=m.state.foldGutter;if(!o){return}var n=o.options;clearTimeout(o.changeUpdate);o.changeUpdate=setTimeout(function(){var p=m.getViewport();if(o.from==o.to||p.from-o.to>20||o.from-p.to>20){l(m)}else{m.operation(function(){if(p.from<o.from){k(m,p.from,o.from);o.from=p.from}if(p.to>o.to){k(m,o.to,p.to);o.to=p.to}})}},n.updateViewportTimeSpan||400)}function e(m,n){var p=m.state.foldGutter;if(!p){return}var o=n.line;if(o>=p.from&&o<p.to){k(m,o,o+1)}}});