(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","diff_match_patch"],a)}else{a(CodeMirror)}}})(function(i){var H=i.Pos;var P="http://www.w3.org/2000/svg";function o(U,V){this.mv=U;this.type=V;this.classes=V=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}o.prototype={constructor:o,init:function(W,V,U){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=i(W,n({value:V,readOnly:!this.mv.options.allowEditingOriginals},n(U)));this.orig.state.diffViews=[this];this.diff=y(c(V),c(U.value));this.chunks=x(this.diff);this.diffOutOfDate=this.dealigned=false;this.showDifferences=U.showDifferences!==false;this.forceUpdate=M(this);N(this,true,false);L(this)},setShowDifferences:function(U){U=U!==false;if(U!=this.showDifferences){this.showDifferences=U;this.forceUpdate("full")}}};function t(U){if(U.diffOutOfDate){U.diff=y(U.orig.getValue(),U.edit.getValue());U.chunks=x(U.diff);U.diffOutOfDate=false;i.signal(U.edit,"updateDiff",U.diff)}}var T=false;function M(W){var X={from:0,to:0,marked:[]};var Y={from:0,to:0,marked:[]};var V,ac=false;function ab(ad){T=true;ac=false;if(ad=="full"){if(W.svg){g(W.svg)}if(W.copyButtons){g(W.copyButtons)}h(W.edit,X.marked,W.classes);h(W.orig,Y.marked,W.classes);X.from=X.to=Y.from=Y.to=0}t(W);if(W.showDifferences){S(W.edit,W.diff,X,DIFF_INSERT,W.classes);S(W.orig,W.diff,Y,DIFF_DELETE,W.classes)}C(W);if(W.mv.options.connect=="align"){a(W)}T=false}function aa(ad){if(T){return}W.dealigned=true;Z(ad)}function Z(ad){if(T||ac){return}clearTimeout(V);if(ad===true){ac=true}V=setTimeout(ab,ad===true?20:250)}function U(ad,ae){if(!W.diffOutOfDate){W.diffOutOfDate=true;X.from=X.to=Y.from=Y.to=0}aa(ae.text.length-1!=ae.to.line-ae.from.line)}W.edit.on("change",U);W.orig.on("change",U);W.edit.on("markerAdded",aa);W.edit.on("markerCleared",aa);W.orig.on("markerAdded",aa);W.orig.on("markerCleared",aa);W.edit.on("viewportChange",function(){Z(false)});W.orig.on("viewportChange",function(){Z(false)});ab();return ab}function L(U){U.edit.on("scroll",function(){Q(U,DIFF_INSERT)&&C(U)});U.orig.on("scroll",function(){Q(U,DIFF_DELETE)&&C(U)})}function Q(X,al){if(X.diffOutOfDate){return false}if(!X.lockScroll){return true}var Y,ag,ad=+new Date;if(al==DIFF_INSERT){Y=X.edit;ag=X.orig}else{Y=X.orig;ag=X.edit}if(Y.state.scrollSetBy==X&&(Y.state.scrollSetAt||0)+50>ad){return false}var aj=Y.getScrollInfo();if(X.mv.options.connect=="align"){ak=aj.top}else{var Z=0.5*aj.clientHeight,ab=aj.top+Z;var aa=Y.lineAtHeight(ab,"local");var U=f(X.chunks,aa,al==DIFF_INSERT);var ae=A(Y,al==DIFF_INSERT?U.edit:U.orig);var af=A(ag,al==DIFF_INSERT?U.orig:U.edit);var ai=(ab-ae.top)/(ae.bot-ae.top);var ak=(af.top-Z)+ai*(af.bot-af.top);var V,ac;if(ak>aj.top&&(ac=aj.top/Z)<1){ak=ak*ac+aj.top*(1-ac)}else{if((V=aj.height-aj.clientHeight-aj.top)<Z){var ah=ag.getScrollInfo();var W=ah.height-ah.clientHeight-ak;if(W>V&&(ac=V/Z)<1){ak=ak*ac+(ah.height-ah.clientHeight-V)*(1-ac)}}}}ag.scrollTo(aj.left,ak);ag.state.scrollSetAt=ad;ag.state.scrollSetBy=X;return true}function A(W,U){var V=U.after;if(V==null){V=W.lastLine()+1}return{top:W.heightAtLine(U.before||0,"local"),bot:W.heightAtLine(V,"local")}}function N(V,W,U){V.lockScroll=W;if(W&&U!=false){Q(V,DIFF_INSERT)&&C(V)}V.lockButton.innerHTML=W?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function h(W,U,V){for(var X=0;X<U.length;++X){var Y=U[X];if(Y instanceof i.TextMarker){Y.clear()}else{if(Y.parent){W.removeLineClass(Y,"background",V.chunk);W.removeLineClass(Y,"background",V.start);W.removeLineClass(Y,"background",V.end)}}}U.length=0}function S(W,V,X,Y,U){var Z=W.getViewport();W.operation(function(){if(X.from==X.to||Z.from-X.to>20||X.from-Z.to>20){h(W,X.marked,U);D(W,V,Y,X.marked,Z.from,Z.to,U);X.from=Z.from;X.to=Z.to}else{if(Z.from<X.from){D(W,V,Y,X.marked,Z.from,X.from,U);X.from=Z.from}if(Z.to>X.to){D(W,V,Y,X.marked,X.to,Z.to,U);X.to=Z.to}}})}function D(ad,ac,ap,ai,af,am,Y){var ak=H(0,0);var an=H(af,0),W=ad.clipPos(H(am-1));var ab=ap==DIFF_DELETE?Y.del:Y.insert;function ah(aw,at){var aq=Math.max(af,aw),ar=Math.min(am,at);for(var au=aq;au<ar;++au){var av=ad.addLineClass(au,"background",Y.chunk);if(au==aw){ad.addLineClass(av,"background",Y.start)}if(au==at-1){ad.addLineClass(av,"background",Y.end)}ai.push(av)}if(aw==at&&aq==at&&ar==at){if(aq){ai.push(ad.addLineClass(aq-1,"background",Y.end))}else{ai.push(ad.addLineClass(aq,"background",Y.start))}}}var X=0;for(var ag=0;ag<ac.length;++ag){var aj=ac[ag],ao=aj[0],al=aj[1];if(ao==DIFF_EQUAL){var Z=ak.line+(O(ac,ag)?0:1);F(ak,al);var aa=ak.line+(s(ac,ag)?1:0);if(aa>Z){if(ag){ah(X,Z)}X=aa}}else{if(ao==ap){var ae=F(ak,al,true);var U=J(an,ak),V=K(W,ae);if(!I(U,V)){ai.push(ad.markText(U,V,{className:ab}))}ak=ae}}}if(X<=ak.line){ah(X,ak.line+1)}}function C(V){if(!V.showDifferences){return}if(V.svg){g(V.svg);var ac=V.gap.offsetWidth;d(V.svg,"width",ac,"height",V.gap.offsetHeight)}if(V.copyButtons){g(V.copyButtons)}var aa=V.edit.getViewport(),ab=V.orig.getViewport();var X=V.mv.wrap.getBoundingClientRect().top;var Y=X-V.edit.getScrollerElement().getBoundingClientRect().top+V.edit.getScrollInfo().top;var Z=X-V.orig.getScrollerElement().getBoundingClientRect().top+V.orig.getScrollInfo().top;for(var W=0;W<V.chunks.length;W++){var U=V.chunks[W];if(U.editFrom<=aa.to&&U.editTo>=aa.from&&U.origFrom<=ab.to&&U.origTo>=ab.from){q(V,U,Z,Y,ac)}}}function z(W,V){var X=0,Z=0;for(var Y=0;Y<V.length;Y++){var U=V[Y];if(U.editTo>W&&U.editFrom<=W){return null}if(U.editFrom>W){break}X=U.editTo;Z=U.origTo}return Z+(W-X)}function u(W,aa){var Z=[];for(var X=0;X<W.chunks.length;X++){var V=W.chunks[X];Z.push([V.origTo,V.editTo,aa?z(V.editTo,aa.chunks):null])}if(aa){for(var X=0;X<aa.chunks.length;X++){var V=aa.chunks[X];for(var Y=0;Y<Z.length;Y++){var U=Z[Y];if(U[1]==V.editTo){Y=-1;break}else{if(U[1]>V.editTo){break}}}if(Y>-1){Z.splice(Y-1,0,[z(V.editTo,W.chunks),V.editTo,V.origTo])}}}return Z}function a(W,X){if(!W.dealigned&&!X){return}if(!W.orig.curOp){return W.orig.operation(function(){a(W,X)})}W.dealigned=false;var ab=W.mv.left==W?W.mv.right:W.mv.left;if(ab){t(ab);ab.dealigned=false}var Z=u(W,ab);var U=W.mv.aligners;for(var Y=0;Y<U.length;Y++){U[Y].clear()}U.length=0;var V=[W.orig,W.edit],ac=[];if(ab){V.push(ab.orig)}for(var Y=0;Y<V.length;Y++){ac.push(V[Y].getScrollInfo().top)}for(var aa=0;aa<Z.length;aa++){b(V,Z[aa],U)}for(var Y=0;Y<V.length;Y++){V[Y].scrollTo(null,ac[Y])}}function b(V,Y,U){var Z=0,ab=[];for(var X=0;X<V.length;X++){if(Y[X]!=null){var aa=V[X].heightAtLine(Y[X],"local");ab[X]=aa;Z=Math.max(Z,aa)}}for(var X=0;X<V.length;X++){if(Y[X]!=null){var W=Z-ab[X];if(W>1){U.push(G(V[X],Y[X],W))}}}}function G(V,X,Y){var U=true;if(X>V.lastLine()){X--;U=false}var W=document.createElement("div");W.className="CodeMirror-merge-spacer";W.style.height=Y+"px";W.style.minWidth="1px";return V.addLineWidget(X,W,{height:Y,above:U})}function q(ab,W,af,ae,al){var ad=ab.type=="left";var ah=ab.orig.heightAtLine(W.origFrom,"local")-af;if(ab.svg){var ai=ah;var ak=ab.edit.heightAtLine(W.editFrom,"local")-ae;if(ad){var ag=ai;ai=ak;ak=ag}var U=ab.orig.heightAtLine(W.origTo,"local")-af;var V=ab.edit.heightAtLine(W.editTo,"local")-ae;if(ad){var ag=U;U=V;V=ag}var aa=" C "+al/2+" "+ak+" "+al/2+" "+ai+" "+(al+2)+" "+ai;var Z=" C "+al/2+" "+U+" "+al/2+" "+V+" -1 "+V;d(ab.svg.appendChild(document.createElementNS(P,"path")),"d","M -1 "+ak+aa+" L "+(al+2)+" "+U+Z+" z","class",ab.classes.connect)}if(ab.copyButtons){var X=ab.copyButtons.appendChild(r("div",ab.type=="left"?"\u21dd":"\u21dc","CodeMirror-merge-copy"));var ac=ab.mv.options.allowEditingOriginals;X.title=ac?"Push to left":"Revert chunk";X.chunk=W;X.style.top=ah+"px";if(ac){var aj=ab.orig.heightAtLine(W.editFrom,"local")-ae;var Y=ab.copyButtons.appendChild(r("div",ab.type=="right"?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));Y.title="Push to right";Y.chunk={editFrom:W.origFrom,editTo:W.origTo,origFrom:W.editFrom,origTo:W.editTo};Y.style.top=aj+"px";ab.type=="right"?Y.style.left="2px":Y.style.right="2px"}}}function m(V,Z,X,U){if(V.diffOutOfDate){return}var W=U.editTo>Z.lastLine()?H(U.editFrom-1):H(U.editFrom,0);var Y=U.origTo>X.lastLine()?H(U.origFrom-1):H(U.origFrom,0);Z.replaceRange(X.getRange(Y,H(U.origTo,0)),W,H(U.editTo,0))}var E=i.MergeView=function(Z,ab){if(!(this instanceof E)){return new E(Z,ab)}this.options=ab;var ac=ab.origLeft,ad=ab.origRight==null?ab.orig:ab.origRight;var V=ac!=null,W=ad!=null;var ae=1+(V?1:0)+(W?1:0);var aj=[],X=this.left=null,ag=this.right=null;var ai=this;if(V){X=this.left=new o(this,"left");var Y=r("div",null,"CodeMirror-merge-pane");aj.push(Y);aj.push(e(X))}var U=r("div",null,"CodeMirror-merge-pane");aj.push(U);if(W){ag=this.right=new o(this,"right");aj.push(e(ag));var ah=r("div",null,"CodeMirror-merge-pane");aj.push(ah)}(W?ah:U).className+=" CodeMirror-merge-pane-rightmost";aj.push(r("div",null,null,"height: 0; clear: both;"));var ak=this.wrap=Z.appendChild(r("div",aj,"CodeMirror-merge CodeMirror-merge-"+ae+"pane"));this.edit=i(U,n(ab));if(X){X.init(Y,ac,ab)}if(ag){ag.init(ah,ad,ab)}if(ab.collapseIdentical){this.editor().operation(function(){j(ai,ab.collapseIdentical)})}if(ab.connect=="align"){this.aligners=[];a(this.left||this.right,true)}var aa=function(){if(X){C(X)}if(ag){C(ag)}};i.on(window,"resize",aa);var af=setInterval(function(){for(var al=ak.parentNode;al&&al!=document.body;al=al.parentNode){}if(!al){clearInterval(af);i.off(window,"resize",aa)}},5000)};function e(U){var W=U.lockButton=r("div",null,"CodeMirror-merge-scrolllock");W.title="Toggle locked scrolling";var X=r("div",[W],"CodeMirror-merge-scrolllock-wrap");i.on(W,"click",function(){N(U,!U.lockScroll)});var V=[X];if(U.mv.options.revertButtons!==false){U.copyButtons=r("div",null,"CodeMirror-merge-copybuttons-"+U.type);i.on(U.copyButtons,"click",function(Z){var aa=Z.target||Z.srcElement;if(!aa.chunk){return}if(aa.className=="CodeMirror-merge-copy-reverse"){m(U,U.orig,U.edit,aa.chunk);return}m(U,U.edit,U.orig,aa.chunk)});V.unshift(U.copyButtons)}if(U.mv.options.connect!="align"){var Y=document.createElementNS&&document.createElementNS(P,"svg");if(Y&&!Y.createSVGRect){Y=null}U.svg=Y;if(Y){V.push(Y)}}return U.gap=r("div",V,"CodeMirror-merge-gap")}E.prototype={constuctor:E,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(U){if(this.right){this.right.setShowDifferences(U)}if(this.left){this.left.setShowDifferences(U)}},rightChunks:function(){if(this.right){t(this.right);return this.right.chunks}},leftChunks:function(){if(this.left){t(this.left);return this.left.chunks}}};function c(U){if(typeof U=="string"){return U}else{return U.getValue()}}var p=new diff_match_patch();function y(U,V){var W=p.diff_main(U,V);p.diff_cleanupSemantic(W);for(var X=0;X<W.length;++X){var Y=W[X];if(!Y[1]){W.splice(X--,1)}else{if(X&&W[X-1][0]==Y[0]){W.splice(X--,1);W[X][1]+=Y[1]}}}return W}function x(Z){var U=[];var af=0,ah=0;var aa=H(0,0),ad=H(0,0);for(var ac=0;ac<Z.length;++ac){var ae=Z[ac],ai=ae[0];if(ai==DIFF_EQUAL){var ag=O(Z,ac)?0:1;var V=aa.line+ag,W=ad.line+ag;F(aa,ae[1],null,ad);var ab=s(Z,ac)?1:0;var X=aa.line+ab,Y=ad.line+ab;if(X>V){if(ac){U.push({origFrom:ah,origTo:W,editFrom:af,editTo:V})}af=X;ah=Y}}else{F(ai==DIFF_INSERT?aa:ad,ae[1])}}if(af<=aa.line||ah<=ad.line){U.push({origFrom:ah,origTo:ad.line+1,editFrom:af,editTo:aa.line+1})}return U}function s(U,V){if(V==U.length-1){return true}var W=U[V+1][1];if(W.length==1||W.charCodeAt(0)!=10){return false}if(V==U.length-2){return true}W=U[V+2][1];return W.length>1&&W.charCodeAt(0)==10}function O(U,V){if(V==0){return true}var W=U[V-1][1];if(W.charCodeAt(W.length-1)!=10){return false}if(V==1){return true}W=U[V-2][1];return W.charCodeAt(W.length-1)==10}function f(Z,ac,ad){var W,U,X,V;for(var ab=0;ab<Z.length;ab++){var Y=Z[ab];var aa=ad?Y.editFrom:Y.origFrom;var ae=ad?Y.editTo:Y.origTo;if(U==null){if(aa>ac){U=Y.editFrom;V=Y.origFrom}else{if(ae>ac){U=Y.editTo;V=Y.origTo}}}if(ae<=ac){W=Y.editTo;X=Y.origTo}else{if(aa<=ac){W=Y.editFrom;X=Y.origFrom}}}return{edit:{before:W,after:U},orig:{before:X,after:V}}}function k(V,W,Y){V.addLineClass(W,"wrap","CodeMirror-merge-collapsed-line");var Z=document.createElement("span");Z.className="CodeMirror-merge-collapsed-widget";Z.title="Identical text collapsed. Click to expand.";var X=V.markText(H(W,0),H(Y-1),{inclusiveLeft:true,inclusiveRight:true,replacedWith:Z,clearOnEnter:true});function U(){X.clear();V.removeLineClass(W,"wrap","CodeMirror-merge-collapsed-line")}i.on(Z,"click",U);return{mark:X,clear:U}}function l(aa,W){var Z=[];function U(){for(var ab=0;ab<Z.length;ab++){Z[ab].clear()}}for(var X=0;X<W.length;X++){var V=W[X];var Y=k(V.cm,V.line,V.line+aa);Z.push(Y);Y.mark.on("clear",U)}return Z[0].mark}function R(W,Z,aa,V){for(var X=0;X<W.chunks.length;X++){var U=W.chunks[X];for(var Y=U.editFrom-Z;Y<U.editTo+Z;Y++){var ab=Y+aa;if(ab>=0&&ab<V.length){V[ab]=false}}}}function j(ad,ab){if(typeof ab!="number"){ab=2}var U=[],W=ad.editor(),ae=W.firstLine();for(var Z=ae,V=W.lastLine();Z<=V;Z++){U.push(true)}if(ad.left){R(ad.left,ab,ae,U)}if(ad.right){R(ad.right,ab,ae,U)}for(var Y=0;Y<U.length;Y++){if(U[Y]){var aa=Y+ae;for(var af=1;Y<U.length-1&&U[Y+1];Y++,af++){}if(af>ab){var X=[{line:aa,cm:W}];if(ad.left){X.push({line:z(aa,ad.left.chunks),cm:ad.left.orig})}if(ad.right){X.push({line:z(aa,ad.right.chunks),cm:ad.right.orig})}var ac=l(af,X);if(ad.options.onCollapse){ad.options.onCollapse(ad,aa,af,ac)}}}}}function r(Z,V,U,Y){var W=document.createElement(Z);if(U){W.className=U}if(Y){W.style.cssText=Y}if(typeof V=="string"){W.appendChild(document.createTextNode(V))}else{if(V){for(var X=0;X<V.length;++X){W.appendChild(V[X])}}}return W}function g(V){for(var U=V.childNodes.length;U>0;--U){V.removeChild(V.firstChild)}}function d(U){for(var V=1;V<arguments.length;V+=2){U.setAttribute(arguments[V],arguments[V+1])}}function n(U,W){if(!W){W={}}for(var V in U){if(U.hasOwnProperty(V)){W[V]=U[V]}}return W}function F(Z,aa,V,X){var Y=V?H(Z.line,Z.ch):Z,U=0;for(;;){var W=aa.indexOf("\n",U);if(W==-1){break}++Y.line;if(X){++X.line}U=W+1}Y.ch=(U?0:Y.ch)+(aa.length-U);if(X){X.ch=(U?0:X.ch)+(aa.length-U)}return Y}function K(U,V){return(U.line-V.line||U.ch-V.ch)<0?U:V}function J(U,V){return(U.line-V.line||U.ch-V.ch)>0?U:V}function I(U,V){return U.line==V.line&&U.ch==V.ch}function w(V,Y,X){for(var W=V.length-1;W>=0;W--){var U=V[W];var Z=(X?U.origTo:U.editTo)-1;if(Z<Y){return Z}}}function v(V,Z,Y){for(var X=0;X<V.length;X++){var U=V[X];var W=(Y?U.origFrom:U.editFrom);if(W>Z){return W}}}function B(U,V){var X=null,ac=U.state.diffViews,aa=U.getCursor().line;if(ac){for(var Y=0;Y<ac.length;Y++){var W=ac[Y],Z=U==W.orig;t(W);var ab=V<0?w(W.chunks,aa,Z):v(W.chunks,aa,Z);if(ab!=null&&(X==null||(V<0?ab>X:ab<X))){X=ab}}}if(X!=null){U.setCursor(X,0)}else{return i.Pass}}i.commands.goNextDiff=function(U){return B(U,1)};i.commands.goPrevDiff=function(U){return B(U,-1)}});