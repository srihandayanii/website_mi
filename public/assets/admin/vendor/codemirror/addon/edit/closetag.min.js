(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../fold/xml-fold"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../fold/xml-fold"],a)}else{a(CodeMirror)}}})(function(e){e.defineOption("autoCloseTags",false,function(i,l,k){if(k!=e.Init&&k){i.removeKeyMap("autoCloseTags")}if(!l){return}var j={name:"autoCloseTags"};if(typeof l!="object"||l.whenClosing){j["'/'"]=function(m){return c(m)}}if(typeof l!="object"||l.whenOpening){j["'>'"]=function(m){return b(m)}}i.addKeyMap(j)});var f=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var g=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function b(j){if(j.getOption("disableInput")){return e.Pass}var u=j.listSelections(),v=[];for(var m=0;m<u.length;m++){if(!u[m].empty()){return e.Pass}var t=u[m].head,z=j.getTokenAt(t);var q=e.innerMode(j.getMode(),z.state),x=q.state;if(q.mode.name!="xml"||!x.tagName){return e.Pass}var s=j.getOption("autoCloseTags"),l=q.mode.configuration=="html";var k=(typeof s=="object"&&s.dontCloseTags)||(l&&f);var o=(typeof s=="object"&&s.indentTags)||(l&&g);var y=x.tagName;if(z.end>t.ch){y=y.slice(0,y.length-z.end+t.ch)}var r=y.toLowerCase();if(!y||z.type=="string"&&(z.end!=t.ch||!/[\"\']/.test(z.string.charAt(z.string.length-1))||z.string.length==1)||z.type=="tag"&&x.type=="closeTag"||z.string.indexOf("/")==(z.string.length-1)||k&&h(k,r)>-1||d(j,y,t,x,true)){return e.Pass}var n=o&&h(o,r)>-1;v[m]={indent:n,text:">"+(n?"\n\n":"")+"</"+y+">",newPos:n?e.Pos(t.line+1,0):e.Pos(t.line,t.ch+1)}}for(var m=u.length-1;m>=0;m--){var p=v[m];j.replaceRange(p.text,u[m].head,u[m].anchor,"+insert");var w=j.listSelections().slice(0);w[m]={head:p.newPos,anchor:p.newPos};j.setSelections(w);if(p.indent){j.indentLine(p.newPos.line,null,true);j.indentLine(p.newPos.line+1,null,true)}}}function a(j,t){var o=j.listSelections(),q=[];var k=t?"/":"</";for(var l=0;l<o.length;l++){if(!o[l].empty()){return e.Pass}var n=o[l].head,s=j.getTokenAt(n);var m=e.innerMode(j.getMode(),s.state),r=m.state;if(t&&(s.type=="string"||s.string.charAt(0)!="<"||s.start!=n.ch-1)){return e.Pass}var p;if(m.mode.name!="xml"){if(j.getMode().name=="htmlmixed"&&m.mode.name=="javascript"){p=k+"script"}else{if(j.getMode().name=="htmlmixed"&&m.mode.name=="css"){p=k+"style"}else{return e.Pass}}}else{if(!r.context||!r.context.tagName||d(j,r.context.tagName,n,r)){return e.Pass}p=k+r.context.tagName}if(j.getLine(n.line).charAt(s.end)!=">"){p+=">"}q[l]=p}j.replaceSelections(q);o=j.listSelections();for(var l=0;l<o.length;l++){if(l==o.length-1||o[l].head.line<o[l+1].head.line){j.indentLine(o[l].head.line)}}}function c(i){if(i.getOption("disableInput")){return e.Pass}return a(i,true)}e.commands.closeTag=function(i){return a(i)};function h(j,l){if(j.indexOf){return j.indexOf(l)}for(var m=0,k=j.length;m<k;++m){if(j[m]==l){return m}}return -1}function d(j,t,r,s,n){if(!e.scanForClosingTag){return false}var l=Math.min(j.lastLine()+1,r.line+500);var p=e.scanForClosingTag(j,r,null,l);if(!p||p.tag!=t){return false}var k=s.context;for(var q=n?1:0;k&&k.tagName==t;k=k.prev){++q}r=p.to;for(var m=1;m<q;m++){var o=e.scanForClosingTag(j,r,null,l);if(!o||o.tag!=t){return false}r=o.to}return true}});