(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a)}else{a(CodeMirror)}}})(function(b){function s(w,v){if(typeof w=="string"){w=new RegExp(w.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),v?"gi":"g")}else{if(!w.global){w=new RegExp(w.source,w.ignoreCase?"gi":"g")}}return{token:function(y){w.lastIndex=y.pos;var x=w.exec(y.string);if(x&&x.index==y.pos){y.pos+=x[0].length||1;return"searching"}else{if(x){y.pos=x.index}else{y.skipToEnd()}}}}}function t(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function i(v){return v.state.search||(v.state.search=new t())}function m(v){return typeof v=="string"&&v==v.toLowerCase()}function h(v,x,w){return v.getSearchCursor(x,w,m(x))}function l(v,z,w,x,y){v.openDialog(z,x,{value:w,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){a(v)},onKeyDown:y})}function d(v,z,y,w,x){if(v.openDialog){v.openDialog(z,x,{value:w,selectValueOnOpen:true})}else{x(prompt(y,w))}}function c(v,y,x,w){if(v.openConfirm){v.openConfirm(y,w)}else{if(confirm(x)){w[0]()}}}function k(v){return v.replace(/\\(.)/g,function(w,x){if(x=="n"){return"\n"}if(x=="r"){return"\r"}return x})}function j(x){var w=x.match(/^\/(.*)\/([a-z]*)$/);if(w){try{x=new RegExp(w[1],w[2].indexOf("i")==-1?"":"i")}catch(v){}}else{x=k(x)}if(typeof x=="string"?x=="":x.test("")){x=/x^/}return x}var n='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function u(v,x,w){x.queryText=w;x.query=j(w);v.removeOverlay(x.overlay,m(x.query));x.overlay=s(x.query,m(x.query));v.addOverlay(x.overlay);if(v.showMatchesOnScrollbar){if(x.annotate){x.annotate.clear();x.annotate=null}x.annotate=v.showMatchesOnScrollbar(x.query,m(x.query))}}function f(v,A,y,x){var C=i(v);if(C.query){return g(v,A)}var z=v.getSelection()||C.lastQuery;if(y&&v.openDialog){var w=null;var B=function(E,D){b.e_stop(D);if(!E){return}if(E!=C.queryText){u(v,C,E);C.posFrom=C.posTo=v.getCursor()}if(w){w.style.opacity=1}g(v,D.shiftKey,function(F,H){var G;if(H.line<3&&document.querySelector&&(G=v.display.wrapper.querySelector(".CodeMirror-dialog"))&&G.getBoundingClientRect().bottom-4>v.cursorCoords(H,"window").top){(w=G).style.opacity=0.4}})};l(v,n,z,B,function(E,G){var F=b.keyName(E);var D=b.keyMap[v.getOption("keyMap")][F];if(!D){D=v.getOption("extraKeys")[F]}if(D=="findNext"||D=="findPrev"||D=="findPersistentNext"||D=="findPersistentPrev"){b.e_stop(E);u(v,i(v),G);v.execCommand(D)}else{if(D=="find"||D=="findPersistent"){b.e_stop(E);B(G,E)}}});if(x&&z){u(v,C,z);g(v,A)}}else{d(v,n,"Search for:",z,function(D){if(D&&!C.query){v.operation(function(){u(v,C,D);C.posFrom=C.posTo=v.getCursor();g(v,A)})}})}}function g(w,x,v){w.operation(function(){var z=i(w);var y=h(w,z.query,x?z.posFrom:z.posTo);if(!y.find(x)){y=h(w,z.query,x?b.Pos(w.lastLine()):b.Pos(w.firstLine(),0));if(!y.find(x)){return}}w.setSelection(y.from(),y.to());w.scrollIntoView({from:y.from(),to:y.to()},20);z.posFrom=y.from();z.posTo=y.to();if(v){v(y.from(),y.to())}})}function a(v){v.operation(function(){var w=i(v);w.lastQuery=w.query;if(!w.query){return}w.query=w.queryText=null;v.removeOverlay(w.overlay);if(w.annotate){w.annotate.clear();w.annotate=null}})}var r=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var q='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var e="Replace? <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>";function p(v,w,x){v.operation(function(){for(var y=h(v,w);y.findNext();){if(typeof w!="string"){var z=v.getRange(y.from(),y.to()).match(w);y.replace(x.replace(/\$(\d)/g,function(A,B){return z[B]}))}else{y.replace(x)}}})}function o(w,v){if(w.getOption("readOnly")){return}var y=w.getSelection()||i(w).lastQuery;var x=v?"Replace all:":"Replace:";d(w,x+r,x,y,function(z){if(!z){return}z=j(z);d(w,q,"Replace with:","",function(D){D=k(D);if(v){p(w,z,D)}else{a(w);var B=h(w,z,w.getCursor("from"));var A=function(){var F=B.from(),E;if(!(E=B.findNext())){B=h(w,z);if(!(E=B.findNext())||(F&&B.from().line==F.line&&B.from().ch==F.ch)){return}}w.setSelection(B.from(),B.to());w.scrollIntoView({from:B.from(),to:B.to()});c(w,e,"Replace?",[function(){C(E)},A,function(){p(w,z,D)}])};var C=function(E){B.replace(typeof z=="string"?D:D.replace(/\$(\d)/g,function(F,G){return E[G]}));A()};A()}})})}b.commands.find=function(v){a(v);f(v)};b.commands.findPersistent=function(v){a(v);f(v,false,true)};b.commands.findPersistentNext=function(v){f(v,false,true,true)};b.commands.findPersistentPrev=function(v){f(v,true,true,true)};b.commands.findNext=f;b.commands.findPrev=function(v){f(v,true)};b.commands.clearSearch=a;b.commands.replace=o;b.commands.replaceAll=function(v){o(v,true)}});