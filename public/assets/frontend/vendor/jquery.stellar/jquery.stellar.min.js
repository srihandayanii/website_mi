/*
 * Stellar.js v0.6.2
 * http://markdalgleish.com/projects/stellar.js
 * 
 * Copyright 2013, Mark Dalgleish
 * This content is released under the MIT license
 * http://markdalgleish.mit-license.org
 */
(function(a,o,c,m){var f="stellar",b={scrollProperty:"scroll",positionProperty:"position",horizontalScrolling:true,verticalScrolling:true,horizontalOffset:0,verticalOffset:0,responsive:false,parallaxBackgrounds:true,parallaxElements:true,hideDistantElements:true,hideElement:function(p){p.hide()},showElement:function(p){p.show()}},j={scroll:{getLeft:function(p){return p.scrollLeft()},setLeft:function(p,q){p.scrollLeft(q)},getTop:function(p){return p.scrollTop()},setTop:function(p,q){p.scrollTop(q)}},position:{getLeft:function(p){return parseInt(p.css("left"),10)*-1},getTop:function(p){return parseInt(p.css("top"),10)*-1}},margin:{getLeft:function(p){return parseInt(p.css("margin-left"),10)*-1},getTop:function(p){return parseInt(p.css("margin-top"),10)*-1}},transform:{getLeft:function(p){var q=getComputedStyle(p[0])[h];return(q!=="none"?parseInt(q.match(/(-?[0-9]+)/g)[4],10)*-1:0)},getTop:function(p){var q=getComputedStyle(p[0])[h];return(q!=="none"?parseInt(q.match(/(-?[0-9]+)/g)[5],10)*-1:0)}}},g={position:{setLeft:function(p,q){p.css("left",q)},setTop:function(p,q){p.css("top",q)}},transform:{setPosition:function(p,q,r,t,s){p[0].style[h]="translate3d("+(q-r)+"px, "+(t-s)+"px, 0)"}}},n=(function(){var q=/^(Moz|Webkit|Khtml|O|ms|Icab)(?=[A-Z])/,s=a("script")[0].style,p="",r;for(r in s){if(q.test(r)){p=r.match(q)[0];break}}if("WebkitOpacity" in s){p="Webkit"}if("KhtmlOpacity" in s){p="Khtml"}return function(t){return p+(p.length>0?t.charAt(0).toUpperCase()+t.slice(1):t)}}()),h=n("transform"),l=a("<div />",{style:"background:#fff"}).css("background-position-x")!==m,k=(l?function(p,q,r){p.css({"background-position-x":q,"background-position-y":r})}:function(p,q,r){p.css("background-position",q+" "+r)}),d=(l?function(p){return[p.css("background-position-x"),p.css("background-position-y")]}:function(p){return p.css("background-position").split(" ")}),i=(o.requestAnimationFrame||o.webkitRequestAnimationFrame||o.mozRequestAnimationFrame||o.oRequestAnimationFrame||o.msRequestAnimationFrame||function(p){setTimeout(p,1000/60)});function e(p,q){this.element=p;this.options=a.extend({},b,q);this._defaults=b;this._name=f;this.init()}e.prototype={init:function(){this.options.name=f+"_"+Math.floor(Math.random()*1000000000);this._defineElements();this._defineGetters();this._defineSetters();this._handleWindowLoadAndResize();this._detectViewport();this.refresh({firstLoad:true});if(this.options.scrollProperty==="scroll"){this._handleScrollEvent()}else{this._startAnimationLoop()}},_defineElements:function(){if(this.element===c.body){this.element=o}this.$scrollElement=a(this.element);this.$element=(this.element===o?a("body"):this.$scrollElement);this.$viewportElement=(this.options.viewportElement!==m?a(this.options.viewportElement):(this.$scrollElement[0]===o||this.options.scrollProperty==="scroll"?this.$scrollElement:this.$scrollElement.parent()))},_defineGetters:function(){var q=this,p=j[q.options.scrollProperty];this._getScrollLeft=function(){return p.getLeft(q.$scrollElement)};this._getScrollTop=function(){return p.getTop(q.$scrollElement)}},_defineSetters:function(){var r=this,q=j[r.options.scrollProperty],p=g[r.options.positionProperty],s=q.setLeft,t=q.setTop;this._setScrollLeft=(typeof s==="function"?function(u){s(r.$scrollElement,u)}:a.noop);this._setScrollTop=(typeof t==="function"?function(u){t(r.$scrollElement,u)}:a.noop);this._setPosition=p.setPosition||function(u,v,w,y,x){if(r.options.horizontalScrolling){p.setLeft(u,v,w)}if(r.options.verticalScrolling){p.setTop(u,y,x)}}},_handleWindowLoadAndResize:function(){var q=this,p=a(o);if(q.options.responsive){p.bind("load."+this.name,function(){q.refresh()})}p.bind("resize."+this.name,function(){q._detectViewport();if(q.options.responsive){q.refresh()}})},refresh:function(r){var s=this,p=s._getScrollLeft(),q=s._getScrollTop();if(!r||!r.firstLoad){this._reset()}this._setScrollLeft(0);this._setScrollTop(0);this._setOffsets();this._findParticles();this._findBackgrounds();if(r&&r.firstLoad&&/WebKit/.test(navigator.userAgent)){a(o).load(function(){var t=s._getScrollLeft(),u=s._getScrollTop();s._setScrollLeft(t+1);s._setScrollTop(u+1);s._setScrollLeft(t);s._setScrollTop(u)})}this._setScrollLeft(p);this._setScrollTop(q)},_detectViewport:function(){var q=this.$viewportElement.offset(),p=q!==null&&q!==m;this.viewportWidth=this.$viewportElement.width();this.viewportHeight=this.$viewportElement.height();this.viewportOffsetTop=(p?q.top:0);this.viewportOffsetLeft=(p?q.left:0)},_findParticles:function(){var s=this,q=this._getScrollLeft(),r=this._getScrollTop();if(this.particles!==m){for(var p=this.particles.length-1;p>=0;p--){this.particles[p].$element.data("stellar-elementIsActive",m)}}this.particles=[];if(!this.options.parallaxElements){return}this.$element.find("[data-stellar-ratio]").each(function(w){var u=a(this),v,H,D,E,x,y,t,z,A,B=0,C=0,F=0,G=0;if(!u.data("stellar-elementIsActive")){u.data("stellar-elementIsActive",this)}else{if(u.data("stellar-elementIsActive")!==this){return}}s.options.showElement(u);if(!u.data("stellar-startingLeft")){u.data("stellar-startingLeft",u.css("left"));u.data("stellar-startingTop",u.css("top"))}else{u.css("left",u.data("stellar-startingLeft"));u.css("top",u.data("stellar-startingTop"))}D=u.position().left;E=u.position().top;x=(u.css("margin-left")==="auto")?0:parseInt(u.css("margin-left"),10);y=(u.css("margin-top")==="auto")?0:parseInt(u.css("margin-top"),10);z=u.offset().left-x;A=u.offset().top-y;u.parents().each(function(){var I=a(this);if(I.data("stellar-offset-parent")===true){B=F;C=G;t=I;return false}else{F+=I.position().left;G+=I.position().top}});v=(u.data("stellar-horizontal-offset")!==m?u.data("stellar-horizontal-offset"):(t!==m&&t.data("stellar-horizontal-offset")!==m?t.data("stellar-horizontal-offset"):s.horizontalOffset));H=(u.data("stellar-vertical-offset")!==m?u.data("stellar-vertical-offset"):(t!==m&&t.data("stellar-vertical-offset")!==m?t.data("stellar-vertical-offset"):s.verticalOffset));s.particles.push({$element:u,$offsetParent:t,isFixed:u.css("position")==="fixed",horizontalOffset:v,verticalOffset:H,startingPositionLeft:D,startingPositionTop:E,startingOffsetLeft:z,startingOffsetTop:A,parentOffsetLeft:B,parentOffsetTop:C,stellarRatio:(u.data("stellar-ratio")!==m?u.data("stellar-ratio"):1),width:u.outerWidth(true),height:u.outerHeight(true),isHidden:false})})},_findBackgrounds:function(){var s=this,q=this._getScrollLeft(),r=this._getScrollTop(),p;this.backgrounds=[];if(!this.options.parallaxBackgrounds){return}p=this.$element.find("[data-stellar-background-ratio]");if(this.$element.data("stellar-background-ratio")){p=p.add(this.$element)}p.each(function(){var u=a(this),v=d(u),w,H,D,E,x,y,z,A,t,B=0,C=0,F=0,G=0;if(!u.data("stellar-backgroundIsActive")){u.data("stellar-backgroundIsActive",this)}else{if(u.data("stellar-backgroundIsActive")!==this){return}}if(!u.data("stellar-backgroundStartingLeft")){u.data("stellar-backgroundStartingLeft",v[0]);u.data("stellar-backgroundStartingTop",v[1])}else{k(u,u.data("stellar-backgroundStartingLeft"),u.data("stellar-backgroundStartingTop"))}x=(u.css("margin-left")==="auto")?0:parseInt(u.css("margin-left"),10);y=(u.css("margin-top")==="auto")?0:parseInt(u.css("margin-top"),10);z=u.offset().left-x-q;A=u.offset().top-y-r;u.parents().each(function(){var I=a(this);if(I.data("stellar-offset-parent")===true){B=F;C=G;t=I;return false}else{F+=I.position().left;G+=I.position().top}});w=(u.data("stellar-horizontal-offset")!==m?u.data("stellar-horizontal-offset"):(t!==m&&t.data("stellar-horizontal-offset")!==m?t.data("stellar-horizontal-offset"):s.horizontalOffset));H=(u.data("stellar-vertical-offset")!==m?u.data("stellar-vertical-offset"):(t!==m&&t.data("stellar-vertical-offset")!==m?t.data("stellar-vertical-offset"):s.verticalOffset));s.backgrounds.push({$element:u,$offsetParent:t,isFixed:u.css("background-attachment")==="fixed",horizontalOffset:w,verticalOffset:H,startingValueLeft:v[0],startingValueTop:v[1],startingBackgroundPositionLeft:(isNaN(parseInt(v[0],10))?0:parseInt(v[0],10)),startingBackgroundPositionTop:(isNaN(parseInt(v[1],10))?0:parseInt(v[1],10)),startingPositionLeft:u.position().left,startingPositionTop:u.position().top,startingOffsetLeft:z,startingOffsetTop:A,parentOffsetLeft:B,parentOffsetTop:C,stellarRatio:(u.data("stellar-background-ratio")===m?1:u.data("stellar-background-ratio"))})})},_reset:function(){var r,s,t,p,q;for(q=this.particles.length-1;q>=0;q--){r=this.particles[q];s=r.$element.data("stellar-startingLeft");t=r.$element.data("stellar-startingTop");this._setPosition(r.$element,s,s,t,t);this.options.showElement(r.$element);r.$element.data("stellar-startingLeft",null).data("stellar-elementIsActive",null).data("stellar-backgroundIsActive",null)}for(q=this.backgrounds.length-1;q>=0;q--){p=this.backgrounds[q];p.$element.data("stellar-backgroundStartingLeft",null).data("stellar-backgroundStartingTop",null);k(p.$element,p.startingValueLeft,p.startingValueTop)}},destroy:function(){this._reset();this.$scrollElement.unbind("resize."+this.name).unbind("scroll."+this.name);this._animationLoop=a.noop;a(o).unbind("load."+this.name).unbind("resize."+this.name)},_setOffsets:function(){var q=this,p=a(o);p.unbind("resize.horizontal-"+this.name).unbind("resize.vertical-"+this.name);if(typeof this.options.horizontalOffset==="function"){this.horizontalOffset=this.options.horizontalOffset();p.bind("resize.horizontal-"+this.name,function(){q.horizontalOffset=q.options.horizontalOffset()})}else{this.horizontalOffset=this.options.horizontalOffset}if(typeof this.options.verticalOffset==="function"){this.verticalOffset=this.options.verticalOffset();p.bind("resize.vertical-"+this.name,function(){q.verticalOffset=q.options.verticalOffset()})}else{this.verticalOffset=this.options.verticalOffset}},_repositionElements:function(){var C=this._getScrollLeft(),D=this._getScrollTop(),t,E,B,s,p,q,r,w=true,v=true,z,A,x,y,u;if(this.currentScrollLeft===C&&this.currentScrollTop===D&&this.currentWidth===this.viewportWidth&&this.currentHeight===this.viewportHeight){return}else{this.currentScrollLeft=C;this.currentScrollTop=D;this.currentWidth=this.viewportWidth;this.currentHeight=this.viewportHeight}for(u=this.particles.length-1;u>=0;u--){B=this.particles[u];s=(B.isFixed?1:0);if(this.options.horizontalScrolling){z=(C+B.horizontalOffset+this.viewportOffsetLeft+B.startingPositionLeft-B.startingOffsetLeft+B.parentOffsetLeft)*-(B.stellarRatio+s-1)+B.startingPositionLeft;x=z-B.startingPositionLeft+B.startingOffsetLeft}else{z=B.startingPositionLeft;x=B.startingOffsetLeft}if(this.options.verticalScrolling){A=(D+B.verticalOffset+this.viewportOffsetTop+B.startingPositionTop-B.startingOffsetTop+B.parentOffsetTop)*-(B.stellarRatio+s-1)+B.startingPositionTop;y=A-B.startingPositionTop+B.startingOffsetTop}else{A=B.startingPositionTop;y=B.startingOffsetTop}if(this.options.hideDistantElements){v=!this.options.horizontalScrolling||x+B.width>(B.isFixed?0:C)&&x<(B.isFixed?0:C)+this.viewportWidth+this.viewportOffsetLeft;w=!this.options.verticalScrolling||y+B.height>(B.isFixed?0:D)&&y<(B.isFixed?0:D)+this.viewportHeight+this.viewportOffsetTop}if(v&&w){if(B.isHidden){this.options.showElement(B.$element);B.isHidden=false}this._setPosition(B.$element,z,B.startingPositionLeft,A,B.startingPositionTop)}else{if(!B.isHidden){this.options.hideElement(B.$element);B.isHidden=true}}}for(u=this.backgrounds.length-1;u>=0;u--){p=this.backgrounds[u];s=(p.isFixed?0:1);q=(this.options.horizontalScrolling?(C+p.horizontalOffset-this.viewportOffsetLeft-p.startingOffsetLeft+p.parentOffsetLeft-p.startingBackgroundPositionLeft)*(s-p.stellarRatio)+"px":p.startingValueLeft);r=(this.options.verticalScrolling?(D+p.verticalOffset-this.viewportOffsetTop-p.startingOffsetTop+p.parentOffsetTop-p.startingBackgroundPositionTop)*(s-p.stellarRatio)+"px":p.startingValueTop);k(p.$element,q,r)}},_handleScrollEvent:function(){var q=this,r=false;var s=function(){q._repositionElements();r=false};var p=function(){if(!r){i(s);r=true}};this.$scrollElement.bind("scroll."+this.name,p);p()},_startAnimationLoop:function(){var p=this;this._animationLoop=function(){i(p._animationLoop);p._repositionElements()};this._animationLoop()}};a.fn[f]=function(q){var p=arguments;if(q===m||typeof q==="object"){return this.each(function(){if(!a.data(this,"plugin_"+f)){a.data(this,"plugin_"+f,new e(this,q))}})}else{if(typeof q==="string"&&q[0]!=="_"&&q!=="init"){return this.each(function(){var r=a.data(this,"plugin_"+f);if(r instanceof e&&typeof r[q]==="function"){r[q].apply(r,Array.prototype.slice.call(p,1))}if(q==="destroy"){a.data(this,"plugin_"+f,null)}})}}};a[f]=function(q){var p=a(o);return p.stellar.apply(p,Array.prototype.slice.call(arguments,0))};a[f].scrollProperty=j;a[f].positionProperty=g;o.Stellar=e}(jQuery,this,document));